--// Current mining target reference
local CurrentTarget = nil

--// Mining loop
task.spawn(function()
    while true do
        if miningActive then
            -- Ensure we have a valid target
            if not CurrentTarget or not (CurrentTarget.model and CurrentTarget.model.Parent) then
                refreshRocks()
                CurrentTarget = MiningList[1]
            end

            if CurrentTarget and CurrentTarget.model and CurrentTarget.model.Parent then
                local part = CurrentTarget.parts[1]
                if part then
                    tpNear(part)
                    task.wait(0.5)
                    leftClickPart(part)

                    local elapsed = 0
                    while CurrentTarget.model and CurrentTarget.model.Parent and miningActive do
                        task.wait(0.2)
                        elapsed += 0.2
                        if elapsed >= 150 then
                            -- Timeout reached, reset target
                            CurrentTarget = nil
                            refreshRocks()
                            break
                        end
                    end
                    -- Refresh after finishing this rock
                    CurrentTarget = nil
                    refreshRocks()
                end
            end
        end
        task.wait(0.5)
    end
end)

--// Safety loop: continuously validate current target
task.spawn(function()
    while true do
        if miningActive and CurrentTarget then
            local valid = CurrentTarget.model and CurrentTarget.model.Parent
            if valid then
                local stillHasPart = false
                for _, p in ipairs(CurrentTarget.parts or {}) do
                    if p and p.Parent then
                        stillHasPart = true
                        break
                    end
                end
                valid = stillHasPart
            end

            if not valid then
                print("[Rocks] Target rock gone - refreshing list.")
                CurrentTarget = nil
                refreshRocks()
            end
        end
        task.wait(1) -- check every second
    end
end)
