-- Player.lua (module)
-- Handles Fly, WalkSpeed, Infinite Jump, and NoClip with settings

local PlayerModule = {}

--// SETTINGS
PlayerModule.settings = {
    FlyEnabled = false,
    FlySpeed = 50,
    WalkSpeedEnabled = false,
    WalkSpeed = 16,
    InfiniteJump = false,
    NoClip = false,
}

--// SERVICES
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

--// STATE
local flying = false
local bodyVelocity, bodyAngularVelocity = nil, nil
local originalWalkSpeed = 16
local initial = { CanCollide = {} }

----------------------------------------------------
-- FLY SYSTEM
----------------------------------------------------
local function startFlying()
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = player.Character.HumanoidRootPart
        bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(4000, 4000, 4000)
        bodyVelocity.Velocity = Vector3.zero
        bodyVelocity.Parent = hrp

        bodyAngularVelocity = Instance.new("BodyAngularVelocity")
        bodyAngularVelocity.MaxTorque = Vector3.new(4000, 4000, 4000)
        bodyAngularVelocity.AngularVelocity = Vector3.zero
        bodyAngularVelocity.Parent = hrp

        flying = true
        print("[PlayerModule] ‚úàÔ∏è Fly enabled")
    end
end

local function stopFlying()
    if bodyVelocity then bodyVelocity:Destroy() bodyVelocity = nil end
    if bodyAngularVelocity then bodyAngularVelocity:Destroy() bodyAngularVelocity = nil end
    flying = false
    print("[PlayerModule] ‚úàÔ∏è Fly disabled")
end

RunService.Heartbeat:Connect(function()
    if flying and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = player.Character.HumanoidRootPart
        local camera = workspace.CurrentCamera
        local moveVector = Vector3.zero

        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveVector += camera.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveVector -= camera.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveVector -= camera.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveVector += camera.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveVector += Vector3.new(0,1,0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then moveVector -= Vector3.new(0,1,0) end

        if bodyVelocity then
            bodyVelocity.Velocity = moveVector * PlayerModule.settings.FlySpeed
        end

        -- üß≠ Make the camera face the character while flying
        -- Keeps camera looking toward HRP
        camera.CFrame = CFrame.new(camera.CFrame.Position, hrp.Position)
    end
end)

----------------------------------------------------
-- WALKSPEED SYSTEM
----------------------------------------------------
RunService.Heartbeat:Connect(function()
    local char = player.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then
            if PlayerModule.settings.WalkSpeedEnabled then
                hum.WalkSpeed = PlayerModule.settings.WalkSpeed
            else
                hum.WalkSpeed = originalWalkSpeed
            end
        end
    end
end)

----------------------------------------------------
-- INFINITE JUMP
----------------------------------------------------
UserInputService.JumpRequest:Connect(function()
    if PlayerModule.settings.InfiniteJump then
        local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
        if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
    end
end)

----------------------------------------------------
-- NOCLIP SYSTEM
----------------------------------------------------
RunService.Stepped:Connect(function()
    if not PlayerModule.settings.NoClip then return end
    local char = player.Character
    if not char then return end

    for _, p in ipairs(char:GetDescendants()) do
        if p:IsA("BasePart") then
            if initial.CanCollide[p] == nil then
                initial.CanCollide[p] = p.CanCollide
            end
            p.CanCollide = false
        end
    end
end)

----------------------------------------------------
-- PUBLIC FUNCTIONS
----------------------------------------------------
function PlayerModule.ToggleFly(enabled)
    PlayerModule.settings.FlyEnabled = enabled
    if enabled then startFlying() else stopFlying() end
end

return PlayerModule
