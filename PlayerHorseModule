-- Handle Fly
if states.Fly then
    local cam = workspace.CurrentCamera
    local move = Vector3.zero

    if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += cam.CFrame.LookVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= cam.CFrame.LookVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= cam.CFrame.RightVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += cam.CFrame.RightVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0, 1, 0) end
    if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then move -= Vector3.new(0, 1, 0) end

    if move.Magnitude > 0 then
        move = move.Unit * PlayerModule.settings.FlySpeed
    end

    local camDir = cam.CFrame.LookVector
    local flatDir = Vector3.new(camDir.X, 0, camDir.Z)
    if flatDir.Magnitude > 0 then flatDir = flatDir.Unit end

    if behaviour == "Riding" then
        -- ensure BV exists
        if not horseBV then
            horseBV = startFlyFor(targetHRP)
        end
        horseBV.Velocity = horseBV.Velocity:Lerp(move, math.clamp(dt * 10, 0, 1))

        -- calculate target CFrame facing camera
        local currentCF = targetHRP.CFrame
        local targetCF = CFrame.lookAt(currentCF.Position, currentCF.Position + flatDir)

        -- compute lean amount from camera turn difference
        local _, currentY = currentCF:ToEulerAnglesYXZ()
        local _, targetY = targetCF:ToEulerAnglesYXZ()
        local turnDiff = math.clamp(targetY - currentY, -math.rad(45), math.rad(45))
        local leanAngle = -math.clamp(turnDiff * 1.2, -0.35, 0.35) -- radians (~20 degrees max)

        -- smoothly rotate and tilt
        local alpha = math.clamp(dt * 8, 0, 1)
        local blendedCF = currentCF:Lerp(targetCF, alpha)
        targetHRP.CFrame = blendedCF * CFrame.Angles(0, 0, leanAngle)

    else
        if not bv then
            bv = startFlyFor(targetHRP)
        end
        if not bg then
            bg = Instance.new("BodyGyro")
            bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
            bg.P = 12500
            bg.CFrame = targetHRP.CFrame
            bg.Parent = targetHRP
        end
        bv.Velocity = bv.Velocity:Lerp(move, math.clamp(dt * 10, 0, 1))
        bg.CFrame = CFrame.lookAt(targetHRP.Position, targetHRP.Position + cam.CFrame.LookVector)
    end
end
