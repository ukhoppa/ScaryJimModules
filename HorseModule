-- HorseModule.lua â€“ Stable Auto Island Wild Horse Scanner
--!strict
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

local HorseModule = {}
local refreshCallback: (({ [number]: table }) -> ())? = nil
local lastListHash = ""

-- Detect which island the player is on by checking HumanoidRootPart
local function detectIsland(): Instance?
    if not Character or not Character:FindFirstChild("HumanoidRootPart") then return nil end
    local hrp = Character.HumanoidRootPart
    local islandsFolder = Workspace:FindFirstChild("Islands")
    if not islandsFolder then return nil end
    for _, island in ipairs(islandsFolder:GetChildren()) do
        if island:IsA("Folder") then
            if hrp:IsDescendantOf(island) then
                return island
            end
        end
    end
    return nil
end

-- Helper to check for special horses
local function isSpecialHorse(info): boolean
    local function containsKeyword(s: string)
        if not s then return false end
        s = s:lower()
        return s:find("ghost") or s:find("neon") or s:find("mummy")
    end
    return containsKeyword(info.breed)
        or containsKeyword(info.colour)
        or containsKeyword(info.mane)
        or containsKeyword(info.tail)
        or (info.instance and containsKeyword(info.instance.Name))
end

-- Get all wild horses on the island
local function getWildHorses(island: Instance?): { [number]: table }
    if not island then return {} end
    local horses: { [number]: table } = {}
    local seen: {[string]: boolean} = {}

    for _, horse in ipairs(island:GetChildren()) do
        if horse:IsA("Model") and horse.Name:sub(1,1) == "{" and horse:FindFirstChild("HumanoidRootPart") and horse:FindFirstChild("OverheadPart") then
            local id = horse.Name
            if seen[id] then continue end
            seen[id] = true

            local overhead = horse.OverheadPart:FindFirstChild("Overhead")
            if overhead and overhead:FindFirstChild("NameLabel") and overhead.NameLabel.Text == "Wild" then
                local breed = overhead:FindFirstChild("BreedLabel") and overhead.BreedLabel.Text or "Unknown"
                local dataAttr = horse:GetAttribute("data")
                local parsedData = {}
                if dataAttr then
                    pcall(function() parsedData = HttpService:JSONDecode(dataAttr) end)
                end
                local variants = parsedData.variants or {}
                local colour = variants.colour or "?"
                local mane = variants.maneColour or "?"
                local tail = variants.tailColour or "?"

                local dist = "?"
                if Character:FindFirstChild("HumanoidRootPart") then
                    dist = math.floor((Character.HumanoidRootPart.Position - horse.HumanoidRootPart.Position).Magnitude)
                end

                table.insert(horses, {
                    instance = horse,
                    id = id,
                    breed = breed,
                    colour = colour,
                    mane = mane,
                    tail = tail,
                    dist = dist,
                })
            end
        end
    end

    -- Sort: specials first, then alphabetically by breed
    table.sort(horses, function(a, b)
        local aSpec = isSpecialHorse(a)
        local bSpec = isSpecialHorse(b)
        if aSpec ~= bSpec then return aSpec end
        return (a.breed or "") < (b.breed or "")
    end)

    return horses
end

-- Build Rayfield button data
local function buildRayfieldData(): { [number]: table }
    local island = detectIsland()
    if not island then return {} end

    local horses = getWildHorses(island)
    local output: { [number]: table } = {}
    for _, h in ipairs(horses) do
        table.insert(output, {
            Id = h.id,
            Name = string.format("ðŸŽ [Breed: %s] [Dist: %s] [Color: %s] [Mane: %s] [Tail: %s]",
                h.breed, tostring(h.dist), h.colour, h.mane, h.tail),
            Color = isSpecialHorse(h) and Color3.fromRGB(180, 90, 255) or Color3.fromRGB(100,70,40),
            Callback = function()
                if Character and Character:FindFirstChild("HumanoidRootPart") and h.instance and h.instance:FindFirstChild("HumanoidRootPart") then
                    Character:PivotTo(CFrame.new(h.instance.HumanoidRootPart.Position + Vector3.new(0,3,0)))
                end
            end
        })
    end
    return output
end

-- Public API
function HorseModule.ScanHorses(): { [number]: table }
    return buildRayfieldData()
end

function HorseModule.GetIslandName(): string
    local island = detectIsland()
    return island and island.Name or "Unknown"
end

function HorseModule.OnUpdate(callback: ({ [number]: table }) -> ())
    refreshCallback = callback
end

-- Auto-refresh loop every second
task.spawn(function()
    while true do
        if refreshCallback then
            local horses = buildRayfieldData()
            local hash = HttpService:JSONEncode(horses)
            if hash ~= lastListHash then
                lastListHash = hash
                pcall(function() refreshCallback(horses) end)
            end
        end
        task.wait(1)
    end
end)

return HorseModule
