--// HorseModule.lua â€“ Auto Island Wild Horse Scanner
--!strict

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

local HorseModule = {}
local refreshCallback: (({ [number]: table }) -> ())? = nil

-- Detect current island
local function detectIsland(): Instance?
	if not Character or not Workspace:FindFirstChild("Islands") then return nil end
	local islands = Workspace:FindFirstChild("Islands")
	local parent = Character.Parent
	while parent and parent ~= Workspace do
		if parent.Parent == islands then return parent end
		parent = parent.Parent
	end
	return nil
end

-- Check if horse is special
local function isSpecialHorse(info): boolean
	local function containsKeyword(s: string)
		local lower = s:lower()
		return lower:find("ghost") or lower:find("neon") or lower:find("mummy")
	end
	return containsKeyword(info.breed or "") 
		or containsKeyword(info.colour or "") 
		or containsKeyword(info.mane or "") 
		or containsKeyword(info.tail or "") 
		or containsKeyword(info.instance.Name or "")
end

-- Get all wild horses on island
local function getWildHorses(island: Instance?): { [string]: table }
	if not island then return {} end
	local horses = {}
	for _, horse in ipairs(island:GetChildren()) do
		if horse:IsA("Model") and horse.Name:sub(1,1) == "{" 
			and horse:FindFirstChild("Humanoid") 
			and horse:FindFirstChild("HumanoidRootPart")
			and horse:FindFirstChild("OverheadPart") then

			local overhead = horse.OverheadPart:FindFirstChild("Overhead")
			if overhead and overhead:FindFirstChild("NameLabel") and overhead.NameLabel.Text == "Wild" then
				local breed = overhead:FindFirstChild("BreedLabel") and overhead.BreedLabel.Text or "Unknown"
				local dataAttr = horse:GetAttribute("data")
				local parsedData = {}
				if dataAttr then pcall(function() parsedData = HttpService:JSONDecode(dataAttr) end) end
				local variants = parsedData.variants or {}
				horses[horse.Name] = {
					instance = horse,
					breed = breed,
					colour = variants.colour or "?",
					mane = variants.maneColour or "?",
					tail = variants.tailColour or "?",
				}
			end
		end
	end
	return horses
end

-- Build button data
local function buildButtonData(): { [number]: table }
	local currentIsland = detectIsland()
	if not currentIsland then return {} end

	local horses = getWildHorses(currentIsland)
	local output = {}

	-- Convert table to array and sort: special horses first, then breed name
	local arr = {}
	for _, info in pairs(horses) do table.insert(arr, info) end
	table.sort(arr, function(a, b)
		local aSpecial = isSpecialHorse(a)
		local bSpecial = isSpecialHorse(b)
		if aSpecial ~= bSpecial then return aSpecial end
		return (a.breed or "") < (b.breed or "")
	end)

	for _, info in ipairs(arr) do
		local horse = info.instance
		local dist = "?"
		if Character:FindFirstChild("HumanoidRootPart") and horse:FindFirstChild("HumanoidRootPart") then
			dist = math.floor((Character.HumanoidRootPart.Position - horse.HumanoidRootPart.Position).Magnitude)
		end
		table.insert(output, {
			Id = horse.Name, -- unique ID
			Name = string.format(
				"[ Breed: %s ][ Dist: %s ][ Colour: %s ][ Mane: %s ][ Tail: %s ]",
				info.breed, dist, info.colour, info.mane, info.tail
			),
			Color = isSpecialHorse(info) and Color3.fromRGB(180, 90, 255) or Color3.fromRGB(100, 70, 40),
			Callback = function()
				if Character:FindFirstChild("HumanoidRootPart") and horse:FindFirstChild("HumanoidRootPart") then
					Character:PivotTo(CFrame.new(horse.HumanoidRootPart.Position + Vector3.new(0,3,0)))
				end
			end,
		})
	end

	return output
end

-- Public API
function HorseModule.ScanHorses(): { [number]: table }
	return buildButtonData()
end

function HorseModule.GetIslandName(): string
	local island = detectIsland()
	return island and island.Name or "Unknown"
end

function HorseModule.OnUpdate(callback: ({ [number]: table }) -> ())
	refreshCallback = callback
end

-- Auto-refresh loop every 1 second
task.spawn(function()
	while true do
		if refreshCallback then
			local data = buildButtonData()
			pcall(function() refreshCallback(data) end)
		end
		task.wait(1)
	end
end)

return HorseModule
